<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitFlow - Build & Break Habits</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <h1 class="loading-title">HabitFlow</h1>
            <div class="loading-spinner"></div>
            <p class="loading-text">Loading your habits...</p>
        </div>
    </div>

    <div id="app" style="display: none;">
        <!-- Home Screen -->
        <div id="home-screen" class="screen active">
            <header class="header">
                <div class="header-content">
                    <h1 class="app-title">HabitFlow</h1>
                    <div class="greeting" id="greeting">Welcome to HabitFlow!</div>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-number" id="days-logged">0</span>
                            <span class="stat-label">Days Logged</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="active-habits">0</span>
                            <span class="stat-label">Active Habits</span>
                        </div>
                    </div>
                    <div class="profile-container">
                        <button id="profile-btn" class="profile-btn" style="display: none;">
                            <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=40&h=40&fit=crop&crop=face" alt="Profile" class="profile-avatar">
                        </button>
                        <div id="profile-dropdown" class="profile-dropdown">
                            <div class="profile-info">
                                <div class="profile-name" id="profile-name">User Name</div>
                                <div class="profile-email" id="profile-email">user@example.com</div>
                            </div>
                            <hr class="profile-divider">
                            <button id="logout-btn" class="logout-btn">
                                <span>Log Out</span>
                            </button>
                        </div>
                    </div>
                    <!-- Auth buttons for non-authenticated users -->
                    <div id="auth-buttons" class="auth-buttons">
                        <a href="login.html" class="auth-link-btn">Sign In</a>
                        <a href="signup.html" class="auth-link-btn primary">Sign Up</a>
                    </div>
                </div>
            </header>
            
            <div class="home-content">
                <div class="habit-flow-card build-card" onclick="navigateTo('build-habits')">
                    <div class="card-background">
                        <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop&crop=center" alt="Build Habits" class="card-image">
                    </div>
                    <div class="card-content">
                        <h3>Build a Habit</h3>
                        <p>Start forming positive habits with proven methods</p>
                    </div>
                </div>
                
                <div class="habit-flow-card break-card" onclick="navigateTo('break-habits')">
                    <div class="card-background">
                        <img src="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=400&h=300&fit=crop&crop=center" alt="Break Habits" class="card-image">
                    </div>
                    <div class="card-content">
                        <h3>Break a Habit</h3>
                        <p>Overcome unwanted behaviors with targeted strategies</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Build Habits Screen -->
        <div id="build-habits-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <button class="back-btn" onclick="navigateTo('home')">← Back</button>
                    <h2>Build a Habit</h2>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="build-search" placeholder="Search habits..." class="search-input" oninput="searchHabits('build')">
            </div>
            
            <div class="habits-list" id="build-habits-list">
                <div class="habit-card" data-habit="drink-water" onclick="selectHabit('drink-water', 'build')">
                    <img src="https://images.unsplash.com/photo-1548839140-29a749e1cf4d?w=80&h=80&fit=crop&crop=center" alt="Water" class="habit-image">
                    <div class="habit-info">
                        <h4>Drink More Water</h4>
                        <p>Stay hydrated and boost your energy</p>
                    </div>
                </div>
                
                <div class="habit-card" data-habit="wake-early" onclick="selectHabit('wake-early', 'build')">
                    <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=80&h=80&fit=crop&crop=center" alt="Sunrise" class="habit-image">
                    <div class="habit-info">
                        <h4>Wake Up Early</h4>
                        <p>Start your day with intention and productivity</p>
                    </div>
                </div>
                
                <div class="habit-card" data-habit="meditation" onclick="selectHabit('meditation', 'build')">
                    <img src="https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=80&h=80&fit=crop&crop=center" alt="Meditation" class="habit-image">
                    <div class="habit-info">
                        <h4>Practice Meditation</h4>
                        <p>Reduce stress and improve mental clarity</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Break Habits Screen -->
        <div id="break-habits-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <button class="back-btn" onclick="navigateTo('home')">← Back</button>
                    <h2>Break a Habit</h2>
                </div>
            </header>
            
            <div class="search-container">
                <input type="text" id="break-search" placeholder="Search habits..." class="search-input" oninput="searchHabits('break')">
            </div>
            
            <div class="habits-list" id="break-habits-list">
                <div class="habit-card" data-habit="procrastination" onclick="selectHabit('procrastination', 'break')">
                    <img src="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=80&h=80&fit=crop&crop=center" alt="Time Management" class="habit-image">
                    <div class="habit-info">
                        <h4>Stop Procrastinating</h4>
                        <p>Overcome delays and boost productivity</p>
                    </div>
                </div>
                
                <div class="habit-card" data-habit="phone-use" onclick="selectHabit('phone-use', 'break')">
                    <img src="https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=80&h=80&fit=crop&crop=center" alt="Phone" class="habit-image">
                    <div class="habit-info">
                        <h4>Quit Excessive Phone Use</h4>
                        <p>Reduce screen time and improve focus</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Screen -->
        <div id="strategy-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <button class="back-btn" onclick="goBack()">← Back</button>
                    <h2 id="strategy-title">Habit Strategy</h2>
                </div>
            </header>
            
            <div class="strategy-content">
                <div class="habit-description" id="habit-description"></div>
                
                <div class="methods-section">
                    <h3>Recommended Methods</h3>
                    <div id="methods-list"></div>
                </div>
                
                <div class="quote-section" id="quote-section" style="display: none;">
                    <h3>Motivation</h3>
                    <blockquote id="motivational-quote"></blockquote>
                </div>
                
                <button class="start-btn" id="start-habit-btn" onclick="startHabit()">Start Habit Plan</button>
            </div>
        </div>

        <!-- Habits Management Screen -->
        <div id="habits-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <h2>My Habits</h2>
                </div>
            </header>
            
            <div class="habits-content" id="habits-content">
                <div class="no-habits" id="no-habits-message">
                    <img src="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=200&h=200&fit=crop&crop=center" alt="No habits" class="no-habits-image">
                    <h3>No Active Habits</h3>
                    <p>Start building or breaking habits from the home screen!</p>
                    <button onclick="navigateTo('home')" class="start-btn">Get Started</button>
                </div>
                
                <div class="active-habits" id="active-habits-list"></div>
            </div>
        </div>

        <!-- Progress Screen -->
        <div id="progress-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <h2>Progress Overview</h2>
                </div>
            </header>
            
            <div class="progress-content" id="progress-content">
                <div class="no-progress" id="no-progress-message">
                    <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=200&h=200&fit=crop&crop=center" alt="No progress" class="no-progress-image">
                    <h3>No Progress Data</h3>
                    <p>Start tracking habits to see your progress!</p>
                    <button onclick="navigateTo('home')" class="start-btn">Get Started</button>
                </div>
                
                <div class="progress-habits" id="progress-habits-list"></div>
            </div>
        </div>

        <!-- Hotline Screen -->
        <div id="hotline-screen" class="screen">
            <header class="header">
                <div class="header-content">
                    <h2>Support & Hotline</h2>
                </div>
            </header>
            
            <div class="hotline-content">
                <div class="support-intro">
                    <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=120&h=120&fit=crop&crop=center" alt="Support" class="support-image">
                    <h3>You're Not Alone</h3>
                    <p>Breaking habits can be challenging. If you're struggling, professional support is available.</p>
                </div>
                
                <div class="hotline-list">
                    <div class="hotline-card">
                        <h4>General Support</h4>
                        <p>24/7 Crisis and Support</p>
                        <div class="phone-number">1-800-EXAMPLE</div>
                    </div>
                    
                    <div class="hotline-card">
                        <h4>Addiction Support</h4>
                        <p>Substance Abuse Helpline</p>
                        <div class="phone-number">1-800-HELP-NOW</div>
                    </div>
                    
                    <div class="hotline-card">
                        <h4>Mental Health</h4>
                        <p>Mental Health Crisis Line</p>
                        <div class="phone-number">1-800-MENTAL</div>
                    </div>
                </div>
                
                <div class="emergency-note">
                    <p><strong>In case of emergency:</strong> Call 911 or go to your nearest emergency room.</p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-btn" onclick="navigateTo('home')" data-tab="home">
                <div class="nav-icon">
                    <img src="https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=24&h=24&fit=crop&crop=center" alt="Home">
                </div>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-btn" onclick="navigateTo('habits')" data-tab="habits">
                <div class="nav-icon">
                    <img src="https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=24&h=24&fit=crop&crop=center" alt="Habits">
                </div>
                <span class="nav-label">Habits</span>
            </button>
            <button class="nav-btn" onclick="navigateTo('progress')" data-tab="progress">
                <div class="nav-icon">
                    <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=24&h=24&fit=crop&crop=center" alt="Progress">
                </div>
                <span class="nav-label">Progress</span>
            </button>
            <button class="nav-btn" onclick="navigateTo('hotline')" data-tab="hotline">
                <div class="nav-icon">
                    <img src="https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=24&h=24&fit=crop&crop=center" alt="Support">
                </div>
                <span class="nav-label">Support</span>
            </button>
        </nav>
    </div>

    <script src="script.js"></script>
    <script type="module">
        let currentUser = null;
        let authInitialized = false;
        let firebaseAvailable = false;
        let initializationStarted = false;

        // Show loading screen initially
        const loadingScreen = document.getElementById('loading-screen');
        const app = document.getElementById('app');

        function hideLoadingScreen() {
            console.log('Hiding loading screen and showing app');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            if (app) {
                app.style.display = 'block';
            }
        }

        function showLoadingScreen() {
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
            }
            if (app) {
                app.style.display = 'none';
            }
        }

        function initializeApp() {
            if (initializationStarted) {
                console.log('App initialization already started, skipping...');
                return;
            }
            
            initializationStarted = true;
            console.log('Initializing HabitFlow app...');
            
            // Hide loading screen and show app
            hideLoadingScreen();
            
            // Initialize the app
            if (window.initApp) {
                window.initApp();
            }
            
            // Update UI based on auth state
            updateAuthUI();
            
            console.log('HabitFlow app initialized successfully');
        }

        function updateAuthUI() {
            const profileBtn = document.getElementById('profile-btn');
            const authButtons = document.getElementById('auth-buttons');
            const greeting = document.getElementById('greeting');
            
            if (currentUser) {
                // User is authenticated
                if (profileBtn) profileBtn.style.display = 'block';
                if (authButtons) authButtons.style.display = 'none';
                if (greeting) greeting.textContent = `Welcome back, ${currentUser.displayName || currentUser.email.split('@')[0]}!`;
            } else {
                // User is not authenticated - show demo mode
                if (profileBtn) profileBtn.style.display = 'none';
                if (authButtons) authButtons.style.display = 'flex';
                if (greeting) greeting.textContent = 'Welcome to HabitFlow!';
            }
        }

        // Immediate fallback - show app after 1 second regardless
        setTimeout(() => {
            if (!initializationStarted) {
                console.log('Quick fallback: Showing app in demo mode');
                initializeApp();
            }
        }, 1000);

        // Try to initialize Firebase with better error handling
        try {
            // Check if we're in a production environment where Firebase might not work
            const isProduction = window.location.hostname !== 'localhost' && 
                                window.location.hostname !== '127.0.0.1' && 
                                !window.location.hostname.includes('replit');
            
            if (isProduction) {
                console.log('Production environment detected, using demo mode');
                setTimeout(initializeApp, 500);
            } else {
                // Try to load Firebase
                import('./src/firebase-config.js').then(async (firebaseModule) => {
                    try {
                        const { auth, db } = firebaseModule;
                        const { onAuthStateChanged, signOut } = await import('firebase/auth');
                        const { doc, getDoc } = await import('firebase/firestore');
                        
                        firebaseAvailable = true;
                        console.log('Firebase loaded successfully');

                        onAuthStateChanged(auth, async (user) => {
                            authInitialized = true;
                            
                            if (user && user.emailVerified) {
                                currentUser = user;
                                
                                try {
                                    // Load user profile data
                                    const greeting = document.getElementById("greeting");
                                    const profileName = document.getElementById("profile-name");
                                    const profileEmail = document.getElementById("profile-email");
                                    
                                    if (greeting && profileName && profileEmail) {
                                        const docRef = doc(db, "users", user.uid);
                                        const docSnap = await getDoc(docRef);
                                        const userData = docSnap.exists() ? docSnap.data() : null;
                                        const displayName = userData?.name || user.displayName || user.email.split('@')[0];
                                        
                                        greeting.textContent = `Welcome back, ${displayName}!`;
                                        profileName.textContent = displayName;
                                        profileEmail.textContent = user.email;
                                    }
                                    
                                    // Show profile button and set up dropdown
                                    const profileBtn = document.getElementById('profile-btn');
                                    const profileDropdown = document.getElementById('profile-dropdown');
                                    const logoutBtn = document.getElementById('logout-btn');
                                    
                                    if (profileBtn && profileDropdown && logoutBtn) {
                                        profileBtn.style.display = 'block';
                                        
                                        // Remove existing event listeners to prevent duplicates
                                        const newProfileBtn = profileBtn.cloneNode(true);
                                        profileBtn.parentNode.replaceChild(newProfileBtn, profileBtn);
                                        
                                        const newLogoutBtn = logoutBtn.cloneNode(true);
                                        logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);
                                        
                                        // Add fresh event listeners
                                        newProfileBtn.addEventListener('click', (e) => {
                                            e.stopPropagation();
                                            profileDropdown.classList.toggle('show');
                                        });
                                        
                                        // Close dropdown when clicking outside
                                        document.addEventListener('click', (e) => {
                                            if (!newProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                                                profileDropdown.classList.remove('show');
                                            }
                                        });
                                        
                                        // Logout functionality
                                        newLogoutBtn.addEventListener('click', async () => {
                                            try {
                                                await signOut(auth);
                                                currentUser = null;
                                                updateAuthUI();
                                            } catch (error) {
                                                console.error('Error signing out:', error);
                                            }
                                        });
                                    }
                                    
                                    // Load user-specific data
                                    await loadUserData(user.uid);
                                    
                                } catch (error) {
                                    console.error('Error loading user data:', error);
                                }
                            } else {
                                currentUser = null;
                            }
                            
                            updateAuthUI();
                            
                            if (!initializationStarted) {
                                initializeApp();
                            }
                        });

                        // Function to load user-specific data
                        async function loadUserData(userId) {
                            try {
                                const userDocRef = doc(db, "users", userId);
                                const userDocSnap = await getDoc(userDocRef);
                                
                                if (userDocSnap.exists()) {
                                    const userData = userDocSnap.data();
                                    // Update the global appData with user's data
                                    if (userData.appData && window.appData) {
                                        Object.assign(window.appData, userData.appData);
                                        if (window.updateHomeScreen) {
                                            window.updateHomeScreen();
                                        }
                                    }
                                }
                            } catch (error) {
                                console.error('Error loading user data:', error);
                            }
                        }

                        // Make currentUser available globally
                        window.getCurrentUser = () => currentUser;
                        
                    } catch (firebaseError) {
                        console.log('Firebase initialization failed:', firebaseError);
                        firebaseAvailable = false;
                        authInitialized = true;
                        if (!initializationStarted) {
                            initializeApp();
                        }
                    }
                }).catch((error) => {
                    console.log('Firebase module loading failed:', error);
                    firebaseAvailable = false;
                    authInitialized = true;
                    if (!initializationStarted) {
                        initializeApp();
                    }
                });
            }
        } catch (error) {
            console.log('Firebase initialization error:', error);
            firebaseAvailable = false;
            authInitialized = true;
            if (!initializationStarted) {
                initializeApp();
            }
        }
        
        // Final fallback timeout - ensure app shows no matter what
        setTimeout(() => {
            if (!initializationStarted) {
                console.log('Final fallback: Force showing app');
                initializeApp();
            }
        }, 2000);

        // Make functions available globally
        window.getCurrentUser = () => currentUser;
        window.firebaseAvailable = () => firebaseAvailable;
    </script>
</body>
</html>
